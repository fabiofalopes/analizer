Neste vÃ­deo vamos continuar a melhorar o nosso controlador de ar condicionado vamos introduzir o conceito de testes de integraÃ§Ã£o que sÃ£o testes um bocadinho diferentes dos Testes unitÃ¡rios que apresentamos no vÃ­deo anterior e a propÃ³sito dos Testes de integraÃ§Ã£o vamos tambÃ©m introduzir um conceito muito importante chamado injeÃ§Ã£o de dependÃªncias Vamos entÃ£o comeÃ§ar pelos testes de integraÃ§Ã£o os testes de integraÃ§Ã£o sÃ£o diferentes destes testes que sÃ£o os testes unitÃ¡rios no sentido em que em vez de estarem apenas um componente uma classe e normalmente nÃ£o tem ligaÃ§Ã£o Ã  interface grÃ¡fica estamos a falar de testar diretamente um objeto sem passar pela interface grÃ¡fica no caso dos Testes de integraÃ§Ã£o nÃ³s vamos simular aÃ§Ãµes sobre uma aplicaÃ§Ã£o que estÃ¡ mesmo a correr no telemÃ³vel ou seja os testes de integraÃ§Ã£o implicam que ele arranque um emulador e a seguir simul aÃ§Ãµes sobre a aplicaÃ§Ã£o que vai aparecendo no emulador E verifi se o resultado Ã© o esperado vamos comeÃ§ar por criar aqui uma pasta chamada integration testarem que ele o Android stud percebe que isto Ã© uma classe de teste e agora vamos tambÃ©m chamar um criar um ficheiro chamado integration test Ok isto poderÃ­amos ir buscar aqui estes testes e fazer uma coisa parecida mas em realidade os nossos testes de integraÃ§Ã£o vÃ£o ser um bocadinho diferentes vÃ£o ter a mesma o Main atÃ© aqui tudo bem mas agora vou ter algumas diferenÃ§as relativamente aos testes que jÃ¡ tÃ­nhamos visto aqui neste nesta Neste vÃ­deo a primeira diferenÃ§a Ã© que tem que incluir na configuraÃ§Ã£o do projeto quer usar uma biblioteca para testes de IntegraÃ§Ã£o eu vou incluir estas linhas aqui no meu pubspec p yamel e fazer pubg para ele obter essa dependÃªncia feito isso eu posso comeÃ§ar por chamar esta linha importÃ¡-la que basicamente Ã© Ã© essencial no inÃ­cio de cada teste de integraÃ§Ã£o para garantir que todos os widgets estÃ£o bem inicializados para se poderem entÃ£o fazer os testes o teste em si em vez de usar o teste eu vou usar o teste widget vou lhe passar Ã  mesma uma descriÃ§Ã£o neste caso vamos testar que diminuindo a temperatura ele reflete isso na temperatura E agora temos aqui uma novidade que Ã© ele recebe aqui uma variÃ¡vel chamada widget tester e a seguir chama um cÃ³digo com esse widget tester que vai testar digamos assim o widget os widgets que pretendemos vamos comeÃ§ar por converter isto para bloco de cÃ³digo Vamos mudar isto para test sÃ³ para ficar mais pequeno e aqui dentro Ã© onde eu vou testar entÃ£o a o este este cenÃ¡rio estes testes tÃªm que ter aqui uma palavrinha assin porque sÃ£o testados de forma assÃ­ncrona e a primeira coisa que eu tenho que fazer aqui Ã© chamar a aplicaÃ§Ã£o propriamente dita como Ã© que eu vou fazer isso num teste de integraÃ§Ã£o vamos comeÃ§ar por olhar aqui para o Main e a minha a minha funÃ§Ã£o Main chama o Run app com o myup o que Ã© que Ã© o myup Ã© um Widget que basicamente tem lÃ¡ toda a minha aplicaÃ§Ã£o atravÃ©s dos widgets que eu depois vou incluindo eu aqui vou fazer o mesmo Mas em vez de chamar runup Vou chamar o tester p Pump widget my app falta importar vou ter apenas que fazer aqui uma pequena alteraÃ§Ã£o que Ã© eu vou ter que usar esta palavrinha a wait no inÃ­cio para indicar que ele tem que esperar que ele que o testa faÃ§a Pump digamos assim deste widget Ou seja que Execute este widget e que ele esteja presente no ecrÃ£ pronto a ser utilizado para a seguir eu continuar vamos jÃ¡ correr isto para ver o que acontece peÃ§o-vos que prestem atenÃ§Ã£o agora o que vai acontecer aqui ok viram test starting depois apareceu o ecrÃ£ durante muito rapidamente menos de 1 segundo e logo ass seg terminou ele diz que o teste passou Ok mas a gente na realidade nÃ£o tÃ¡ ainda a testar nada o que Ã© que falta aqui faltam os expects eu tenho que testar que ele estÃ¡ a ter o comportamento correto e nÃ£o apenas que estÃ¡ a executar para isso o que Ã© que eu quero testar neste caso vou comeÃ§ar por testar que a temperatura que Ã© mostrada logo quando arrancamos a aplicaÃ§Ã£o Ã© temperatura 25 para isso eu tenho que obter digamos o widget que apresenta essa informaÃ§Ã£o e para isso eu devo ter uma chave associada a esse widget eu jÃ¡ tenho aqui uma chave se repararem aqui associada a este widget que Ã© o que apresenta a temperatura cham temperatura TR Tex esta indicaÃ§Ã£o esta string aqui estÃ¡ convÃ©m que seja Ãºnica se vocÃªs tiverem vÃ¡rios widgets com a mesma chave ele depois nÃ£o sabe procurÃ¡-lo nÃ£o sabe identificar o correto e eu AlÃ©m disso tambÃ©m jÃ¡ fiz aqui uma alteraÃ§Ã£o que Ã© aqui nos botÃµes se repararem eles tambÃ©m passaram a ter uma aqui ok o text Button com o menos e o mais e eu atribui o valor diminui Button a chave diminui Button ao Quando Ã© o menos e quando Ã© o mais chama-lhe aumenta Button reparem que este aqui existem todos os widgets portanto qualquer widget flutter vocÃªs podem associar um aqui para depois poderem nos testes referenci como Ã© que a gente vai referenciar esta aqui vamos usar uma variÃ¡vel find que existe automaticamente quando nÃ³s usamos a funÃ§Ã£o test widgets e Chamamos o by Key e aqui se lhe passarmos uma Key tem que ser um objeto do tipo I com o mesmo identificador que nÃ³s usamos no cÃ³digo claro ok ele neste caso ele vai encontrar uma vai encontrar o nosso widget que a gente quer chamar a isto temperatura text Finder ou seja Isto vai Ã© o digamos o objeto responsÃ¡vel por encontrar o widget com esta chave nÃ³s podemos encontrar o widget por vÃ¡rias formas neste caso vamos usar por chave que Ã© a forma que eu recomendo e agora vamos para jÃ¡ verificar que este Finder sÃ³ encontra um widget e apenas um encontra um e apenas um widget Ok Este Ã© o nosso primeiro expect Ã© uma prÃ¡tica comeÃ§amos para verificar se realmente existe este widget antes de tentarmos ver qual Ã© o seu valor agora nÃ³s queremos ver se dentro deste widget estÃ¡ contido do texto que nos interessa Ora bem para isso nÃ³s vamos usar o tester pon widget e vamos passar-lhe o temperatura text Finder O que Ã© que isto retorna isto retorna o widget que estÃ¡ que foi retornado por este Finder digamos assim o Finder nÃ£o retorna diretamente um widget mas atravÃ©s deste tester P widget a gente consegue obter o widget respectivo ou seja na realidade a gente vai chamar a isto temperatura text widget ok Ok Isto Ã© o widget Ã© este widget Ok Ã© este que aqui estÃ¡ aqui estÃ¡ ele ok este widget que aqui estÃ¡ vai ser o que ele vai retornar aqui nesta variÃ¡vel ora tendo este widget eu vou ter acesso ao seu valor e posso fazer um expect temperatura text widget ponto esperem eu aqui tenho que mudar aqui uma coisa isto nÃ£o pode ser sÃ³ assim eu tenho que dizer Isto Ã© do tipo text vamos importar para que ele aqui possa ter aqui um data que Ã© o que me interessa Ã© a forma de eu dentro de um widget do tipo text obter o valor que lÃ¡ estÃ¡ dentro e agora aqui coloco diretamente o valor que eu estava Ã  espera de encontrar Vamos comeÃ§ar por pÃ´r um valor invÃ¡lido Ou seja eu acho que ele vai apresentar a temperatura 20 na realidade a gente sabe que ele vai apresentar a temperatura 25 portanto este teste deverÃ¡ falhar Vamos tentar correr de facto o teste falhou e bem e ele atÃ© inclusivamente disse que ele estava Ã  espera temperatura 20 e o que apareceu foi temperatura 25 Portanto ele tÃ¡ a funcionar como era suposto portanto se eu agora Meter aqui 25 ele jÃ¡ deverÃ¡ passar o teste mas o teste nÃ£o termina por aqui eu agora or quero simular o carregar no botÃ£o menos e a temperatura deverÃ¡ passar aÃ­ sim a 24 para isso eu vou fazer vou usar uma novamente um Finder mas agora Ã© do diminui Button e aqui vai ser o diminui Button tenho um novo Finder para o meu botÃ£o como mandam as boas prÃ¡ticas eu devo comeÃ§ar por verificar se existe um widget com esta chave e de seguida vou simular um toque nesse botÃ£o e isso Ã© feito atravÃ©s do tester PT passo o diminui Button Finder este tester tem um efeito sobre o ecrÃ£ todos os todas as aÃ§Ãµes que eu faÃ§o com o tester que podem ter efeito sobre o ecrÃ£ como elas demoram algum tempo eu tenho que fazer um await antes disso tenho que colocar aqui um await nÃ£o tenho que fazer isso nos exps mas tenho que fazer nos testers que mudam o ecrÃ£ AlÃ©m disso eu tenho que fazer uma coisa que Ã© fazer um tester p Pump o que isto significa Ã© apÃ³s fazeres o Tap do diminui Button Finder faz um refresh ao ecrÃ£ para que ele volte a reconstruir o ecrÃ£ tendo em conta a reaÃ§Ã£o a este botÃ£o Se quiserem Isto Ã© o equivalente a chamar o build novamente de todos os widgets que estÃ£o envolvidos no ecrÃ£ posso ir buscar novamente este widget que aqui estÃ¡ eu vou ter que ir buscar novamente portanto eu vou tirado aqui o final para poder modificar esta variÃ¡vel e vou copiar para aqui e agora isto em princÃ­pio vai ficar com temperatura 24 viram ali muito rapidamente este teste a ser simulado inclusivamente aqui a indicaÃ§Ã£o do que aconteceu ele comeÃ§ou por desenhar o ecrÃ£ desenhar H atual priu menos a temperatura passou a 24 voltou a desenhar o ecrÃ£ hora atual e eu confirmei aqui que de facto este temperatura Tex widget tinha agora o temperatura 24 temos entÃ£o o nosso teste de integraÃ§Ã£o criado bem isto parece tudo muito bem mas este teste tem um problema este teste depende do facto da temperatura ser inicializada a 25 isso por acaso acontece neste momento porque a gente tem aqui este controlador AC que tÃ¡ inicializado com 25 mas isso mais tarde isto mudar e se isto passar a ser uma coisa dinÃ¢mica que vai buscar a Ãºltima temperatura ou temperatura ambiente este teste vai deixar de funcionar EntÃ£o nÃ³s vamos ter que alterar isto para passar a usar uma tÃ©cnica chamada injeÃ§Ã£o de dependÃªncias para ficar mais claro deixa deixa mostrar-vos este diagrama Ora bem temos entÃ£o o nosso my app que atravÃ©s do mÃ©todo build constrÃ³i toda a aplicaÃ§Ã£o em particular constrÃ³i o controlador AC peitos que tem uma dependÃªncia vou usar agora essa terminologia uma dependÃªncia deste objeto ele precisa deste objeto para quÃª para mostrar a temperatura atual para aumentar a temperatura e para diminuir no entanto ele tambÃ©m cria este objeto e esse Ã© o problema aqui ele nÃ£o pode criar este objeto quando se fala de injeÃ§Ã£o dependÃªncias o que se faz o que se fala Ã© de retirar a instanciaÃ§Ã£o do objeto de dentro destes widgets para passar para fora ou seja quando eu digo passar para fora refiro-me a estes dois casos o Main P Dart vai querer inicializar este objeto de uma forma diferente do integration test P Dart EntÃ£o o que Ã© que temos que fazer primeira coisa Ã© para a injeÃ§Ã£o dependÃªncias funcionar Ã© retirar a instanciaÃ§Ã£o do objeto a criaÃ§Ã£o do objeto aqui dentro dentro ele passa a obter esse controlador jÃ¡ vamos ver como e portanto ele deixa de a gente deixa de poder dizer que ele estÃ¡ inicializado a 25Âº NÃ³s nÃ£o sabemos como Ã© que ele foi inicializado apenas usamos a dependÃªncia que nos Ã© injetada como Ã© que Ã© entÃ£o criada essa dependÃªncia bem o Main ponto deart cria essa dependÃªncia com uma certa inicializaÃ§Ã£o neste caso 20 graus o integration test cria com outra inicializaÃ§Ã£o ambos passam essa informaÃ§Ã£o ao controlador ac peit e ele limita-se a usar a dependÃªncia que lhe foi ada portanto em resumo o controlador AC peds deixa de criar o objeto controlador AC pois passao a receber esse objeto tendo sido criado por outra classe umas vezes o Main P Dart outras vezes o integration test P Dart EntÃ£o como Ã© que isto se vai refletir aqui a nÃ­vel de cÃ³digo para comeÃ§ar temos que tirar daqui esta instanciaÃ§Ã£o deste objeto nÃ³s nÃ£o podemos criar este objeto aqui ele tem que ser criado no meio portanto eu vou copiar isto para Main vou tirar isto porque esta variÃ¡vel nÃ£o precisa de ser private a gente jÃ¡ vai ver isso e agora A ideia Ã© que eu passe este controlador AC Ã© my app que por sua vez passa ao controlador AC pites passa por aqui fora e eu aqui deixo de criar e ele passa a ser digamos obtido a partir daquilo que lhe Ã© e dado eu para jÃ¡ vou deixar assim eh porque se eu tirar isto isto vai deixar de compilar JÃ¡ jÃ¡ vamos jÃ¡ voltamos aqui eu agora quero falar sobre esta problemÃ¡tica esta ideia de passar o objeto atravÃ©s dos vÃ¡rios construtores pode funcionar para aplicaÃ§Ãµes simples mas para aplicaÃ§Ãµes mais complexas comeÃ§a a ser complicado quando eu tenho muitos widgets estar permanentemente a passar todos os objetos que eu preciso lÃ¡ para dentro entÃ£o nÃ³s vamos fazer uso de uma biblioteca externa chamada provider essa biblioteca para a gente poder usÃ¡-la vamos acrescentar aqui este provider NÃ£o esquecer de fazer pubg sempre que se altera este ficheiro para ele obter a resp etiva dependÃªncia e agora vamos alterar aqui este my App para fazer um Wap com um widget chamado provider o que este widget vai fazer Ã© providenciar um objeto a todos os descendentes que estÃ£o aqui do child para jÃ¡ ele tÃ¡-se a caixar que precisa de um argumento Create Vamos sÃ³ aqui pÃ´r aqui uma virgula para poder formatar isto pronto entÃ£o o provider tem um Create e um Child O child Ã© o my App Ã© aquilo que jÃ¡ antes tÃ­nhamos mas eu aqui no Create vou poder passar-lhe um objeto que vai ser disponibilizado a todos os descendentes de myap Ã© sÃ³ isto portanto ao fazer isto qualquer coisa que eu retorno aqui qualquer objeto que eu retorno aqui ele Ã© providenciada H uma forma de passar esse objeto para todos os descendentes dap como Ã© que isso Ã© feito atravÃ©s desta variÃ¡vel Ok esta variÃ¡vel contexto eu consigo obter o objeto que foi inicializado no provider para isso eu vou alterar isto para este controlador AC Deixa de ser inicializado aqui passa a ser inicializado aqui eu aqui nÃ£o preciso deste und e aqui vou fazer um read sÃ³ colocar aqui controlador AC p perceber que o que eu quero obter Ã© um controlador AC isto porque eu posso ter vÃ¡rios objetos eu posso atravÃ©s do provider passar vÃ¡rios objetos isto deixa isto desaparece Ok eu obtive o control c eu deixei de o criar alguÃ©m o criou e eu obtivo atravÃ©s desta linha eu agora tenho que alterar isto para deixar de ter o und e aqui no build Button eu tenho aqui referÃªncias ao contol da Ac e agora sim estas eu vou passar diretamente ao ao mÃ©todo ou seja aqui no build Button eu vou-lhe passar um controlador Ac aqui tambÃ©m vou dizer que quero um Adicionar este parÃ¢metro e aqui vou retirar isto tudo pronto eu basicamente o que Ã© que eu fiz sÃ³ resum ainda coisa aqui no provider criei o objeto no m atravÃ©s deste provider ele chegou ao widget que o queria obter neste caso era o controlle ACP Mas qualquer widget que tenha um build com o contexto pode obter este objeto e finalmente a acedi ao objeto como acedia antes e no caso do build Button ainda passei lÃ¡ para dentro o objeto para que o build Button pudesse aceder Ã s propriedades do mesmo o que Ã© que falta aqui para isto funcionar para jÃ¡ eu quero alterar isto para que a temperatura passe a ser 20 agora no Main e Vamos alterar o nosso integration test para tambÃ©m usar o provider essa Ã© que Ã© a vantagem a grande vantagem desta abordagem que estamos a tomar Portanto vamos fazer umaes coisa se calhar atÃ© vou copiar daqui que Ã© mais fÃ¡cil vou copiar isto que aqui estÃ¡ e aqui em vez de my app vou colocar isto ah falta-me copiar tambÃ©m o controlador AC ten que importar ten que importar o provider e aqui eu vou colocar 25 porque aqui Ã© o que eu estou Ã  espera lembram-se Ã© o que estou Ã  espera Ã© que o controlador comece com o valor 25 mas eu agora fiquei deixei de estar dependente daquilo que Ã© inicializado no m no m estÃ¡ inicializado 20 aqui estÃ¡ inicializado 25 e ambos vÃ£o funcionar Vamos sÃ³ verificar vou comeÃ§ar por testar o Main jÃ¡ estÃ¡ comeÃ§a a 20 disparar e agora vou correr os testes reparem O que Ã© que vai aparecer aqui viram 25 e 24 aprendemos Neste vÃ­deo a criar testes de integraÃ§Ã£o testes diferentes dos Testes unitÃ¡rios no sentido em que testam a aplicaÃ§Ã£o de forma integrada atravÃ©s do emulador e atravÃ©s de interaÃ§Ã£o com a parte grÃ¡fica E aprendemos tambÃ©m que para isso funcionar bem e de forma independente da da inicializaÃ§Ã£o da aplicaÃ§Ã£o em si devemos usar uma tÃ©cnica chamada injeÃ§Ã£o de dependÃªncias em que nÃ³s inicializam os objetos do modelo no teste de forma independente dos objetos no Main e eles sÃ£o passados atravÃ©s do provider para dentro dos widgets que dele precisam
