Neste vÃ­deo vamos continuar a trabalhar nesta aplicaÃ§Ã£o do lord of drinks neste momento os dados que aqui estÃ£o estÃ£o fixos Isto foi mostrado no Ãºltimo vÃ­deo nÃ³s agora vamos ligar isto ao servidor para passar a ter os personagens reais do Lord of Rings primeira coisa que eu quero fazer antes de ligar isto ao servidor Ã© melhorar um bocadinho a arquitetura desta aplicaÃ§Ã£o neste momento esta classe de repositÃ³rio eu vou sÃ³ mostrar tem os tais dados fixos ela Ã© criada explicitamente ela Ã© instanciada explicitamente aqui no characters list page e depois tambÃ©m no Character detail page e eu acho que isto nÃ£o Ã© forma correta nÃ³s DevÃ­amos injetar esta dependÃªncia porque se no futuro quisermos fazer testes em que nÃ£o vamos ao servidor quando corremos os testes e vamos ao servidor concorremos a aplicaÃ§Ã£o real nÃ³s vamos querer injetar uma dependÃªncia diferente em cada um dos casos e desta forma torna-se mais complicado fazer este tipo de comportamento Portanto vamos comeÃ§ar jÃ¡ por usar o provider que jÃ¡ aprenderam n outro vÃ­deo meu para injetar este Cars repositÃ³rio aqui para injetar este characters repository aqui para comeÃ§ar temos que ir aqui ao pubspec amel e acrescentar a dependÃªncia acrescentei tambÃ©m jÃ¡ aqui esta dependÃªncia do http que vamos precisar mais Ã  frente nÃ£o esqueÃ§a de fazer pubg e agora jÃ¡ podemos usar aqui o provider para isso vamos fazer Contex e temos que dizer aqui qual Ã© o objeto que queremos obter neste caso repository e aqui vamos precisar da mesma coisa aqui importar pronto o que que falta ainda quando nÃ³s usamos o provider para isto funcionar nÃ³s temos que no Main dizer que isto estÃ¡ encapsulado num provider temos que ter um Create Eu agora vou simplificar isto eu nÃ£o preciso deste contexto jÃ¡ agora quando vocÃªs nÃ£o precisam do argumento que estÃ¡ no lambda vocÃªs podem simplesmente trocÃ¡-lo por um und e Aqui podemos usar uma expressÃ£o e aqui o que eu quero Ã© basicamente dizer qual Ã© o objeto que eu vou providenciar os widgets que sim o pretenderem neste caso Ã© um Character characters repository Vamos sÃ³ ver se isto funciona Ok continua a funcionar agora com o provider estÃ¡ mais organizado Vamos entÃ£o avanÃ§ar para a parte da Api para comeÃ§ar temos que ver onde Ã© que nÃ³s vamos buscar estes personagens a que servidor Ã© que nÃ³s vamos buscar isto existe um Api para isso portanto se forem aqui este endereÃ§o de One api.dev eh documentation vÃ£o ver aqui a documentaÃ§Ã£o para Acer este api e em particular vÃ£o ver aqui que existem vÃ¡rios end points disponÃ­veis para obter informaÃ§Ã£o todos eles comeÃ§am com este endereÃ§o e depois acrescentam Ã  frente qual a operaÃ§Ã£o Qual a entidade que querem obter pod ter os livros os filmes e na realidade o que eu quero Ã© obter este Ou seja a lista de personagens que constituem o Lord of drinks Ã© uma boa prÃ¡tica antes de comeÃ§armos jÃ¡ a programar fazemos alguns testes com esta api nÃ³s prÃ³prios fazemos umas chamadas Api para vermos se entendemos o que Ã© que ela tÃ¡ a fazer Existem vÃ¡rias ferramentas para fazer nomeadamente hÃ¡ uma muito conhecida que Ã© o Postman Mas e o intellij TR uma forma o intelij a versÃ£o Ultimate apenas essa versÃ£o mas que Ã© acessÃ­vel a todos os estudantes traz tambÃ©m uma forma de fazer pedidos apis o caso do Android Studio infelizmente nÃ£o Traz essa funcionalidade entÃ£o podem instalar eventualmente um plugin eu vou instalar aqui um plugin chamado rest console nÃ£o Ã© nada de especial aviso jÃ¡ mas dÃ¡ para sÃ³ para experimentar EntÃ£o como Ã© que nÃ³s vamos dar Este plugin ele aparece aqui rest console ele por acaso jÃ¡ aqui TÃ¡ gravado jÃ¡ tinha gravado e o que eu tinha colocado cÃ¡ antes mas basicamente se repararem aqui em cima colocam o endereÃ§o que querem chamar jÃ¡ tÃ­nhamos visto que tinha que se comeÃ§ar por V2 e depois era tinha que comeÃ§ar por este prefixo digamos assim depois de ter o Car e hÃ¡ aqui um pormenor importante que Ã© este header que Ã© preciso passar que tem a ver com isto aqui OK Eu tenho que enviar este cabeÃ§alho em todos os meus pedidos sendo que isto aqui deve ser substituÃ­do por uma chave de api que vocÃªs devem obter atravÃ©s de uma conta que devem criar aqui portanto eu criei uma conta atravÃ©s dessa conta obtive o m e vou subi-la aqui e Ã© isso que aparece aqui ok aqui tenho a seguir a barer tenho a minha app e aqui que me foi atribuÃ­da a mim vocÃªs se quiserem experimentar isto devem obter a vossa prÃ³pria ap aqui e colocar aqui ok uma vez feito isto eu posso agora fazer submit e passado a um bocado ele dÃ¡-me entÃ£o o resultado da chamada stpi Ok cÃ¡ estÃ£o as passagens todas estÃ£o num formato chamado Jason este formato Ã© um formato muito conhecido ele comeÃ§a por ter aqui um parÃ¢metro doc que lÃ¡ dentro tem uma lista is significa que Ã© uma lista de entidades neste caso personagens por exemplo neste caso esta personagem tem o nome adanel e Ã© humano Ã© uma um feminino etc e e vamos pÃ´ Aqui fora por aqui fora temos imensas personagens e no final atÃ© hÃ¡ uns atributos que dizem que na realidade hÃ¡ 933 personagens depois hÃ¡ aqui um limite um offset nÃ£o Ã© usado neste caso Ã© com isto que a gente vai trabalhar para conseguir mostrar aqui estas mesmas personagens que aqui estÃ£o primeira coisa que eu vou fazer Ã© criar uma classe que me permite fazer pedidos http os pedidos api eu vou comeÃ§ar por criar aqui uma pasta http e um ficheiro http client vamos ver o que Ã© que tÃ¡ aqui a acontecer eu basicamente estou a usar este este client que vem da biblioteca http a tal que jÃ¡ pisemos no pubspec no inÃ­cio do vÃ­deo e Ã© com esse client que eu vou trabalhar mas mais tarde quiser trocar isto para outra biblioteca Ã© ramente fÃ¡cil de o fazer e depois tenho aqui entÃ£o o Mat get Eu tambÃ©m um post Mas neste caso apenas vou precisar de Gets que recebe dois parÃ¢metros o RL ao qual quero fazer o pedido e um conjunto de headers que quer passar ao pedido pois limito-me a delegar isso neste client a Tenho apenas que fazer aqui uma transformaÃ§Ã£o o RL vem em string e o este client quer um R entÃ£o tenho que fazer este o r parse o RL mas de resto Ã© relativamente linear no entanto ele tÃ¡ a sublinhar isto e eu deixei este erro de propÃ³sito vamos ver o que Ã© que ele diz ele diz que estava Ã  espera que esta funÃ§Ã£o retornasse um Future response e nÃ£o um response Qual Ã© a razÃ£o disto e o que Ã© que Ã© esta histÃ³ria dos futures a ideia aqui Ã© que este Esta funÃ§Ã£o ela vai pode demorar algum tempo nÃ£o Ã© ir ao servidor pode demorar alguns segundos e nÃ³s nÃ£o queremos prender a aplicaÃ§Ã£o durante esse processo nomeadamente Se tivermos a desenhar coisas no ecrÃ£ nÃ£o queremos parar de desenhar coisas no ecrÃ£ nÃ£o queremos parar de responder a eventos por isso esta funÃ§Ã£o Ã© aquilo que se desig uma funÃ§Ã£o assÃ­ncrona quando a funÃ§Ã£o Ã© assÃ­ncrona significa que nÃ£o fica bloqueada Ã  espera que termine ela tem que retornar aquilo que se chama um Future o Future Ã© um objeto que inicialmente tÃ¡ no estado incompleto digamos assim e depois eventualmente alg no tempo vai ficar no estado completo portanto nÃ³s Recebemos um objeto que nÃ£o tem logo o resultado que nÃ³s queremos ao transformarmos isto vamos seguir a sugestÃ£o dele ao transformar isto entÃ£o num Future response o que isto diz Ã© que este response vai estar encapsulado num objeto que inicialmente nÃ£o vai ter lÃ¡ a resposta mas que mais tarde eventualmente passado alguns segundos vai ter a resposta entÃ£o Ã© com isto que nÃ³s temos que trabalhar sempre que fizermos pedidos remotos temos que trabalhar com futures vamos agora comeÃ§ar a transformar o nosso Car repository para passar entÃ£o a usar este http client e fazer os pedidos ao servidor eu vou deixar Ã  mesmo este return para jÃ¡ por aqui porque vai dar jeito para nesta fase de testes mas vou jÃ¡ criar aqui uma variÃ¡vel que vai ser o meu http client e eu podia agora fazer aqui isto mas mais uma vez nÃ£o Ã© boa ideia nÃ³s sabemos que Ã© uma boa prÃ¡tica que fazer injeÃ§Ã£o de dependÃªncias em vez de estarmos a criar as dependÃªncias aqui eu nÃ£o sei se mais tarde nÃ£o vou querer alterar esta dependÃªncia com suÃ£o estou em teste ou nÃ£o estou em testes EntÃ£o o que nÃ³s vamos fazer Ã© providenciar este htp client atravÃ©s de injeÃ§Ã£o dependÃªncias no entanto nÃ£o vamos poder fazer da forma que fizemos aqui lembrar que aqui nÃ³s obtivemos a dependÃªncia por exemplo do characters repositÃ³rio atravÃ©s deste contexto read no entanto nÃ³s aqui nÃ£o temos nenhum contexto para obter isso entÃ£o esta Ã© uma limitaÃ§Ã£o da biblioteca que estamos usar que Ã© o provider que apenas permite injetar dependÃªncias em widgets os widgets Ã© quem tem aquela variÃ¡vel build contexto que obtm atravÃ©s da funÃ§Ã£o build como nÃ£o temos essa ligaÃ§Ã£o vamos fazer isto old school digamos assim que Ã© passar atravÃ©s do Construtor eu vou querer que isto seja named ou seja que isto seja um atributo com nome e vou dizer que isto nÃ£o Ã© assim Ã© um http Cent e agora vou ter que fazer aqui para indicar que este client corresponde ao und client que Ã© privado ten que tirar tambÃ©m daqui isto pronto desta forma respeitamos o princÃ­pio do encapsulamento o client fica privado dentro do repositÃ³rio Ã© passado atravÃ©s do Construtor atravÃ©s do nome ou seja client dois pontos qualquer coisa e eu atribuo o parÃ¢metro que recebo ao atributo und client feito isto eu tenho que alterar aqui jÃ¡ isto Ok portanto como Ã© um eh parÃ¢metro por nome eu tive que dizer client dois pontos fica bastante tambÃ©m mais claro agora vamos voltar aqui e agora o get characters tem que usar este client para fazer um get a um endereÃ§o ou seja ele recebe um RL e uns cabeÃ§alhos Ok vamos comeÃ§ar pelo URL vamos buscÃ¡-lo aqui ainda o temos aqui isto tem que comeÃ§ar por https do P bar Barra isto e agora preciso tambÃ©m dos headers que sÃ£o um map um map em Dart Ã© sÃ³ fazer assim em que a chave vai ser este autorisation e o valor vai ser o valor que ali estÃ¡ sÃ³ aqui ir buscÃ¡-lo tem que ser todo neste momento nÃ³s estamos a chamar jÃ¡ o servidor mas nÃ£o estamos a fazer nada com resposta Vamos guardar a resposta aqui num response E agora temos aqui um problema que Ã© este response este get Ã© assÃ­ncrono o quer dizer que este response Ã© um Future response nÃ£o Ã© um response Ou seja eu nÃ£o consigo agora chegar aqui se eu fizer um print response ele nÃ£o vai dar nada de jeito Vamos ver isso em AÃ§Ã£o jÃ¡ dar um out Restart pel voltar ao botÃ£o e agora cÃ¡ estÃ¡ o que ele escreve Ã© um instance de Future response Mas o que eu quero Ã© poder obter mesmo a resposta propriamente dita entÃ£o nesta fase o que eu vou fazer Ã© usar esta palavrinha a significa vou esperar que a resposta vou esperar que o futuro que ele me devolve esteja completo no fundo e nessa altura como o futuro JÃ¡ estÃ¡ completo O que ele me vai devolver Ã em vez de um Future response vai-me jÃ¡ devolver um response Isto significa que eu basicamente estou a bloquear a execuÃ§Ã£o do meu programa neste ponto vou esperar que ele acabe de fazer o que tem a fazer para entÃ£o escrever a resposta hÃ¡ aqui sÃ³ duas coisas que acontecem quando nÃ³s colocamos aqui este await sempre que nÃ³s colocarmos um await dentro de uma funÃ§Ã£o ele vai se queixar a dizer que a funÃ§Ã£o tem tem que ser assÃ­ncrona E para isso nÃ³s vamos acrescentar aqui este assin mas ao acrescentar este assin a seguir ele queixa-se outra coisa que Ã© a funÃ§Ã£o assÃ­ncronas tem que retornar um Future e portanto eu tenho que converter isto para Future Pronto agora Se eu correr isto novamente ah agora ele queixa-se como Isto Ã© um Future agora isto deixou de funcionar porquÃª porque ele tÃ¡ Ã  espera de receber uma lista de characters e nÃ£o um Future de uma lista de characters que Ã© o que ele estÃ¡ a receber neste momento para nÃ³s resolvermos isto facilmente vamos tirar isto dentro do Set state Vamos colocar aqui fora jÃ¡ vou explicar porquÃª e vamos colocar aqui o famoso a sei sempre que vocÃªs quiserem transformar um Future qualquer coisa nessa coisa podem fazer um a oit mas isso tem sempre um preÃ§o a pagar que Ã© a funÃ§Ã£o na qual fazem isso tem que passar a ser assim nunca se esqueÃ§am disso porque Ã© que eu passei isto para fora para onpress em vez de estar no set state porque o set state nÃ£o pode ser assÃ­ncrono eu nÃ£o posso eu podia fazer isto aqui dentro mas is quer-me dar um erro e Portanto ele nÃ£o deixa fazer isso aqui dentro do Set state Vou colocar aqui onpress vai ficar bloqueado Ã Espera da resposta deste pedido ao servidor quando obtiver essa resposta vai obter uma lista de characters e nessa altura o que Ã© que a gente faz no set state nada a gente pode simplesmente deixar um set state vazio para indicar que ele deve refrescar o ecrÃ£ agora que jÃ¡ tem um characters preenchido a variÃ¡vel ktas jÃ¡ estÃ¡ preenchida ele deve refrescar a deve voltar a chamar o build e quando o ctas jÃ¡ tÃ¡ preenchido ele se bem se lembram ele tem aqui Um characters exempt que se jÃ¡ estiver preenchido ele vai chamar o build list e portanto nesta altura vai preencher isto jÃ¡ com a lista de characters que nÃ³s pretendemos agora resolvemos isto JÃ¡ podemos Ok e agora se fizermos get characters reparem que agora ele jÃ¡ dÃ¡ uma InstÃ¢ncia de response o que Ã© que Ã© esta InstÃ¢ncia esta instÃ¢ncia Ã© do tipo response e em particular hÃ¡ duas coisas que nos interessam no response A primeira Ã© o status code o que Ã© que Ã© isto o status code se nÃ³s olharmos aqui para o rest conso alÃ©m desta resposta em Jason ele tambÃ©m retornou um 200 Ok portanto a primeira coisa que ele fez Ã© ver se este cÃ³digo de erro que aqui estÃ¡ ou melhor se este cÃ³digo http de resposta Ã© o 200 que Ã© o cÃ³digo universalmente definido para Ok devemos comeÃ§ar por ver isso porque pode ter corrido mal e nÃ£o termos recebido nada de jeito temos recebido um erro e portanto nÃ£o vamos tentar processar o Jason que estÃ¡ associado a esse erro entÃ£o primeiro primira coisa que devos fazer Ã© um if o status code Ã© igual a 200 que Ã© o ok entÃ£o Ã© que vamos processar o Jason caso contrÃ¡rio vamos lanÃ§ar para jÃ¡ uma exceÃ§Ã£o sÃ³ indicando Qual foi o status code que recebemos para percebermos o que Ã© que estÃ¡ a acontecer em princÃ­pio nÃ£o DevÃ­amos receber algo diferente 200 Por isso queremos que ele lance uma sessÃ£o para nos indicar que aconteceu alguma coisa imprevista agora que sabemos que vem um ok significa que entÃ£o o response traz lÃ¡ dentro um body que Ã© uma string que contÃ©m isto contÃ©m isto que aqui estÃ¡ nÃ³s agora queremos processar isto isto estÃ¡ como string mas nÃ³s queremos que isto seja num formato estruturado isto na realidade Ã© como se fosse um map que lÃ¡ dentro tem Chaves por exemplo o DOC que neste caso corresponde a uma lista de mais uma vez Maps que tem ID chave ID valor tal chave H valor tal chave Race Ok estÃ£o a ver portanto um map com uma lista de Maps digamos assim lÃ¡ dentro entÃ£o vamos comeÃ§ar a trabalhar isto primeira coisa que temos que fazer Ã© converter precisamente de string para uma coisa mais estruturada felizmente o Dart Tem uma funÃ§Ã£o chamada Jason Decode que faz precisamente isso Pega numa string que tem Jason e retorna um formato mais estruturado e agora como isto estÃ¡ no formato estruturado nÃ³s podemos fazer trabalhar nisto como se fosse um map ou seja por exemplo podemos ir aqui buscar o Docs sÃ³ aqui voltar a mostrar ok e ele vai nos dar Isto daqui para baixo ou seja vaios dar uma lista de coisas para ver em AÃ§Ã£o vou jÃ¡ imprimir aqui o response de Jason doc sÃ³ para verem o que Ã© que estÃ¡ a acontecer Vamos entÃ£o aqui ok estÃ£o a ver que o que ele tÃ¡ a dar Ã© uma lista isto significa que Ã© uma lista este parÃªnteses reto depois lÃ¡ dentro tem entÃ£o estes atributos o quer dizer que eu agora posso guardar por exemplo isto numa lista e agora posso iterar essa lista e para cada elemento posso por exemplo escrever o seu nome para cada Car Jason eu posso escrever o seu nome como Ã© que eu sei qual Ã© o atributo que tem o nome mais uma vez venho aqui ver e de facto H aqui um name entÃ£o Ã© aÃ­ que eu vou buscar vamos correr isto novamente reparem que eu estou sempre a fazer hot Restart porque eu quero que ele volte ao botÃ£o para que eu possa agora entÃ£o fazer isto e cÃ¡ estÃ£o os nomes todos aqui que vieram do Servidor O que Ã© que agora quero fazer com isto eu jÃ¡ tenho uma classe Character Como podem ver aqui e o que eu quero Ã© que essa classe Character em vez de estar com dados fixos seja com os dados que vÃªm daqui ou seja este ID havia de ser o Character Jason no atributo ID este name serÃ¡ o Character Jason no atributo Name etc etc para fazer isso eu vou criar aqui uma funÃ§Ã£o aqui no car que me permite criar um objeto destes a partir do Jason respectivo isto Ã© uma boa prÃ¡tica Normalmente quando se trabalha com apis normalmente a gente pega nos objetos do modelo e alÃ©m de ter um Construtor normal como temos aqui temos uma outra forma de criar esse objeto diretamente a partir do Jason como Ã© que isto funciona tenho aqui Esta funÃ§Ã£o from map ela recebe um map que Ã© o basicamente o que vem do Jason e a seguir retorna uma um objeto baseado nos atributos que vÃª de lÃ¡ podemos ver aqui que und ID corresponde ao ID temos o birth temos o death E por aÃ­ fora com base nesta funÃ§Ã£o nÃ³s podemos agora facilmente aqui fazer isto que Ã© podemos criar aqui um ok e assim obtemos um Car Mas o que eu quero Ã© obter uma lista de characters o que eu podia fazer agora era criar uma lista vazia ir adicionando Ã  medida que percorri o ciclo um a um os quer Traz essa lista mas vamos fazer isto de uma forma melhor vamos usar o map que jÃ¡ foi falado num vÃ­deo sobre navegaÃ§Ã£o em flutter que eu jÃ¡ coloquei para bas amente transformar objetos desta lista do tipo Jason vamos chamar-lhe assim em objetos do tipo Car pegar nesta lista fazer um map ou seja o map significa transformar e o que eu tenho aqui Ã© o Car Jason Eu atÃ© vou copiar daqui que Ã© para vocÃªs verem as semelhanÃ§as e o que eu quero fazer Ã© pegar nesse e transformÃ¡-lo no carter entÃ£o basicamente o que isto estÃ¡ a fazer Ã© pegar nesta lista de car Jason e transformar numa outra lista em que cada Car de Jason Ã© transformado no respectivo Character usando esta funÃ§Ã£o AlÃ©m disso eu tenho que converter isto para uma lista agora jÃ¡ posso colocar isto numa lista characters Isto pode ser eliminado e basicamente o que eu vou fazer Ã© retornar estes Cars Ah ele tem eu aqui tenho que diz dizer que isto Ã© um list Character porque senÃ£o depois ele aqui nÃ£o sabe que estou a retornar um Future de um list Character reparem que hÃ¡ aqui uma coisa interessante nas funÃ§Ãµes assÃ­ncronas que Ã© nÃ³s estamos a retornar um objeto do tipo list Character mas o tipo de retorno que aqui estÃ¡ Ã© Future list Character ou seja ele automaticamente percebe como Ã© uma funÃ§Ã£o assÃ­ncrona que que a gente quer retornar na realidade Ã© um Future deste tipo que aqui Ã© retornado como Ã© que isto funciona quando alguÃ©m chamar Esta funÃ§Ã£o este Future vai comeÃ§ar a portar nÃ£o preenchido incompleto Se quiserem enquanto Esta funÃ§Ã£o nÃ£o termina e depois mal ela termine com este return o Future passa a estar preenchido com esta lista de Cars cÃ¡ estÃ¡ graÃ§as a este a nÃ³s vamos bloquear aqui e sÃ³ quando isto terminar Ã© que nÃ³s vamos obter uma lista de characters para entÃ£o mostrar no ecrÃ£ EntÃ£o vamos ver isto a funcionar cÃ¡ estÃ¡ demorou um bocadinho mas temos entÃ£o aqui os nossos personagens todos obtidos a partir do daquele Jason esta abordagem parece funcionar bem mas tem alguns problemas em particular quando carregamos no botÃ£o DevÃ­amos ter feedback por exemplo uma rodinha a rodar ou um uma indicaÃ§Ã£o loading a dizer que tÃ¡ um processamento em curso nÃ£o parece carregamos no botÃ£o e nÃ£o aconteceu nada se aquilo demorar alguns segundos o utilizador vai ficar perdido o outro problema tem a ver com o ponto onde nÃ³s chamamos api neste momento estamos a chamar em reaÃ§Ã£o um evento ou seja dentro de uma funÃ§Ã£o onpressed que pode ser Tornada assÃ­ncrona mas por vezes nÃ³s queremos que seja no momento em que abrimos um novo ecrÃ£ que seja feita a chamada assÃ­ncrona ora o Build a construÃ§Ã£o do ecrÃ£ tem que ser feito de forma sÃ­ncrona entÃ£o isso vai criar aqui problemas acrescidos fiquem para o prÃ³ximo vÃ­deo para ver como vamos resolver estes dois problemas
